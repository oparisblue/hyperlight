#!/usr/bin/env node
"use strict";var ne=require("dns");var a="hyperlight",N="0.1",y="hyperlight.json";var t={Reset:"\x1B[0m",FgRed:"\x1B[31m",FgGreen:"\x1B[32m",FgYellow:"\x1B[33m",FgMagenta:"\x1B[35m",FgCyan:"\x1B[36m",FgGray:"\x1B[90m",BgRed:"\x1B[41m",BgGreen:"\x1B[42m",BgYellow:"\x1B[43m",BgMagenta:"\x1B[45m",BgCyan:"\x1B[46m",BgGray:"\x1B[100m"};var T=require("readline");function f(e){return new Promise(o=>{let r=(0,T.createInterface)({input:process.stdin,output:process.stdout});r.question(`${t.FgGreen}?${t.Reset} ${e} ${t.FgCyan}`,i=>{r.close(),process.stdout.write(t.Reset),o(i)})})}var P=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"];function oe(){process.stdout.write("\x1B[?25l")}function ie(){process.stdout.write("\x1B[?25h")}function p(e=""){let o=!0,r=0,i=()=>{o&&(process.stdout.clearLine(-1),process.stdout.cursorTo(0),process.stdout.write(`${t.FgCyan}${P[r]}${t.Reset} ${e}`),r=(r+1)%P.length,setTimeout(i,100))};return oe(),i(),(s,u)=>{o=!1,process.stdout.clearLine(-1),process.stdout.cursorTo(0),ie(),process.stdout.write(`${s?`${t.FgGreen}\u2714`:`${t.FgRed}\u2716\uFE0F`}${t.Reset} ${e} ${u}
`)}}function n(e){console.log(`  ${e}`)}function c(e){console.log(`  \u2022 ${e}`)}async function w(e){return(await f(`${e} (${t.FgGreen}y${t.Reset}/${t.FgRed}n${t.Reset}) `)).trim().toLowerCase().startsWith("y")}async function $(e){try{let r=await(await fetch(`${e}?json`)).json();if(!r.schemaPath||typeof r.schemaPath!="string"||!r.rpcPath||typeof r.rpcPath!="string")return;let s=await(await fetch(r.schemaPath)).json();return Array.isArray(s)?{schema:s,rpcPath:r.rpcPath}:void 0}catch{return}}function x(){c("Make sure you entered a valid URL, beginning with http:// or https://"),c("If you're running locally, make sure the service is up"),c("Check your configuration: Make sure your service is not in dev mode, or hiding its ping / schema endpoints"),c("Make sure the URL you entered is the ping URL for your service -- you should be able to go there and see the welcome message in your browser"),c("If you changed your ping URL in your configuration, make sure you're using the one that you specified"),c("If your server is remote, make sure your computer has an internet connection"),n("")}var C=require("fs"),I=require("path");function m(e){switch(e.type){case"null":return"null";case"undefined":return"undefined";case"void":return"void";case"numberLiteral":case"stringLiteral":case"booleanLiteral":return JSON.stringify(e.value);case"number":return"number";case"boolean":return"boolean";case"string":return"string";case"union":return`(${e.types.map(o=>m(o)).join("|")})`;case"array":return`${m(e.itemType)}[]`;case"object":return`{${e.keyValuePairTypes.map(([o,r])=>`${o}: ${m(r)}`).join(", ")}}`;case"date":return"Date"}}function E(e,o){let r=`//
// ******* AUTOGENERATED BY ${a.toUpperCase()} *******
//

// Fetch + encoding helpers
function rpcFetch(t:string){return async(...e:any[])=>{let r=await(await fetch("${o}?"+t,{method:"POST",body:JSON.stringify({name:t,params:e.map(c)})})).json();return a(r)}}function c(t:any):any{return t instanceof Date?{v:t.toISOString(),t:"date"}:Array.isArray(t)?{v:t.map(e=>c(e))}:typeof t=="object"&&t!=null?{v:Object.entries(t).reduce((e,[n,r])=>({...e,[n]:c(r)}),{})}:{v:t}}function a(t:any):any{let e=t.v;return t.t==="date"&&typeof e=="string"?new Date(e):Array.isArray(e)?e.map(n=>a(n)):typeof e=="object"&&e!=null?Object.entries(e).reduce((n,[r,o])=>({...n,[r]:a(o)}),{}):e}

// Generated RPC methods

`;for(let i of e){let s=i.functionName,u=i.params.map(({name:l,type:G})=>`${l}: ${m(G)}`).join(", "),g=m(i.returnType);if(i.jsDoc){r+=`/**
`;for(let l of i.jsDoc.split(`
`))r+=`* ${l}
`;r+=`*/
`}r+=`export const ${s}:(${u}) => Promise<${g}> = rpcFetch("${s}");

`}return r}var k=!1;async function b(e){return k?!0:(k=!0,e.environment==="node"&&e.clients.length===0?(n(`${t.FgYellow}Note:${t.Reset} You're running this command on your server, which doesn't currently have any clients configured.`),n("While having a server/client combo is totally valid, we just thought we'd check this is what you want?"),n(""),await w("Would you like to proceed?")):!0)}async function R(e){let o=await b(e);if(!o)return;let r=!1;if(e.clients.length===0)return o||await w("There are no clients or no configuration file. Would you like to add a client now?")?(await F(e,void 0),!0):!1;for(let i of e.clients)await se(i)||(r=!0);return r?(n(""),n(`${t.FgRed}One or more clients failed to generate${t.Reset}`),x(),!1):!0}async function se(e){let o=p(`Generating ${e.out} against ${e.url}...`),r=await $(e.url);if(!r)return o(!1,"failed"),!1;let i=E(r.schema,r.rpcPath);return(0,C.mkdirSync)((0,I.dirname)(e.out),{recursive:!0}),(0,C.writeFileSync)(e.out,i),o(!0,"done"),!0}var d=require("fs"),L=require("path");function M(){return(0,L.join)(process.cwd(),y)}function O(){let e=M();if(!(0,d.existsSync)(e))return{clients:[]};let o=(0,d.readFileSync)(e).toString(),r=JSON.parse(o);if("clients"in r&&!Array.isArray(r.clients)||r.clients?.some(s=>!s||typeof s!="object"||!("url"in s)||!("out"in s)||typeof s.url!="string"||typeof s.out!="string"))throw new Error(`Malformed clients array in ${y}`);let i="environment"in r&&r.environment==="node"?"node":void 0;return{clients:r.clients??[],environment:i}}function Y(e){(0,d.writeFileSync)(M(),JSON.stringify(e,null,2))}async function F(e,o){if(!await b(e))return;let i=o??"",s=!!o;for(;;){s||(i=await f("Enter the address of the server to generate against (e.g. http://localhost:3000): "),i===""&&(i="http://localhost:3000"));let l=p("Checking your server...");if(await $(i)){l(!0,"done!");break}l(!1,"failed"),x(),s&&(n(`${t.FgRed}The URL you entered in the command-line arguments didn't work${t.Reset}, but you can try another one now.`),n(""),s=!1)}let u=await f("Enter the path where the output will be generated (e.g. src/client.generated.ts): ");u===""&&(u="src/client.generated.ts");let g={...e,clients:[...e.clients,{url:i,out:u}]};return Y(g),n(""),await R(g),n(""),n(`${t.FgGreen}Config saved!${t.Reset}`),g}var te=require("fs"),A=require("path");var B=require("fs");function U(e){(0,B.mkdirSync)(e)}var h=require("child_process"),_=require("fs"),D=require("path");function J(e,o){let r=(0,h.execSync)("/usr/bin/id -F").toString().trim();(0,_.writeFileSync)((0,D.join)(e,"package.json"),JSON.stringify({name:o,version:"0.1.0",author:r,license:"UNLICENSED",main:"./build/index.js",scripts:{prepare:"ts-patch install -s",build:`tsc && esbuild --bundle ./build-tmp --minify --platform=node --external:${a} --outfile=build/index.js && rm -rf ./build-tmp`,start:"yarn build && node ./build/index.js"}},null,2)),(0,h.spawnSync)(`yarn --cwd ${e} add ${a}`,{shell:!0}),(0,h.spawnSync)(`yarn --cwd ${e} add --dev ts-patch esbuild`,{shell:!0})}var S=require("child_process"),W=require("fs"),H=require("path");function V(e){(0,W.writeFileSync)((0,H.join)(e,".gitignore"),[".DS_Store","Thumbs.DB","","node_modules","","build","*.generated",""].join(`
`)),(0,S.execSync)(`git init ${e}`),(0,S.execSync)(`git -C ${e} add .`),(0,S.execSync)(`git -C ${e} commit --all --message="Initial commit"`)}var q=require("fs"),X=require("path");function z(e){(0,q.writeFileSync)((0,X.join)(e,"tsconfig.json"),JSON.stringify({compilerOptions:{strict:!0,lib:["ESNext"],rootDir:"src",outDir:"build-tmp",plugins:[{transform:`${a}/lib/patch`}],module:"NodeNext",skipLibCheck:!0,esModuleInterop:!0}},null,2))}var K=require("fs"),Q=require("path");function Z(e){(0,K.writeFileSync)((0,Q.join)(e,y),JSON.stringify({environment:"node"},null,2))}var v=require("fs"),j=require("path");function ee(e){let o=(0,j.join)(e,"src");(0,v.mkdirSync)(o),(0,v.writeFileSync)((0,j.join)(o,"index.ts"),ae)}var ae=`import { init } from "${a}";

/** @endpoint */
export function hello() {
  return "Hello, world!";
}

init({ devMode: true, port: 3000 });
`;async function re(e){n(`${t.FgMagenta}Thanks for choosing ${a}!${t.Reset}`),n(""),n("We'll create a new folder for your project in the current directory."),n("");let o=e||await ce();n("");let r=p("Hang tight..."),i=(0,A.join)(process.cwd(),o);U(i),J(i,o),z(i),Z(i),ee(i),V(i),r(!0,"done!"),n(""),n(`${t.FgGreen}Your project is ready at:${t.Reset} ${i}`),n(`Run ${t.FgMagenta}yarn build${t.Reset} to build your project, and ${t.FgMagenta}yarn start${t.Reset} to start it`),n(""),n(`Once your server is all up and running, you can run ${t.FgMagenta}npx hyperlight generate${t.Reset} in your client project to run codegen against it`)}async function ce(){for(;;){let e=await f("What do you want to call it?");if(e===""){n(`${t.FgYellow}You must enter a name${t.Reset}`);continue}if(!(0,te.existsSync)((0,A.join)(process.cwd(),e)))return e;n(`${t.FgYellow}An item with that name already exists here.${t.Reset} Please try something else`)}}(0,ne.setDefaultResultOrder)("ipv4first");async function ue(){let e=process.argv.slice(2),o;try{o=O()}catch(r){n(`${t.FgRed}Failed to read config${t.Reset}`),n(r.message);return}if(e[0]==="create-server-project"){await re(e[1]);return}if(e[0]==="add-client"){await F(o,e[1]);return}if(e[0]==="generate"){await R(o);return}le()}function le(){n(`${a} version ${N}`),n(""),c(`${a} add-client`),n(`  ${t.FgGray}Adds a client to the configuration file for generation${t.Reset}`),n(""),c(`${a} generate`),n(`  ${t.FgGray}Runs codegen for all clients in the configuration file${t.Reset}`),n(""),c(`${a} create-server-project`),n(`  ${t.FgGray}Creates and sets up a new backend ${a} project${t.Reset}`),n("")}ue();
