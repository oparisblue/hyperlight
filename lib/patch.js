"use strict";var w=Object.create;var m=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var R=Object.getPrototypeOf,v=Object.prototype.hasOwnProperty;var E=(e,r)=>{for(var t in r)m(e,t,{get:r[t],enumerable:!0})},y=(e,r,t,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of S(r))!v.call(e,n)&&n!==t&&m(e,n,{get:()=>r[n],enumerable:!(o=A(r,n))||o.enumerable});return e};var T=(e,r,t)=>(t=e!=null?w(R(e)):{},y(r||!e||!e.__esModule?m(t,"default",{value:e,enumerable:!0}):t,e)),$=e=>y(m({},"__esModule",{value:!0}),e);var J={};E(J,{default:()=>k});module.exports=$(J);var b=T(require("typescript"));var a=T(require("typescript"));function g(e,r){if(e.flags&a.default.TypeFlags.Number)return{type:"number"};if(e.flags&a.default.TypeFlags.Boolean)return{type:"boolean"};if(e.flags&a.default.TypeFlags.String)return{type:"string"};if(e.flags&a.default.TypeFlags.Null)return{type:"null"};if(e.flags&a.default.TypeFlags.Undefined)return{type:"undefined"};if(e.flags&a.default.TypeFlags.Void)return{type:"void"};if(e.isNumberLiteral())return{type:"numberLiteral",value:e.value};if(e.isStringLiteral())return{type:"stringLiteral",value:e.value};if(D(e))return{type:"booleanLiteral",value:e.intrinsicName==="true"};if(e.isUnion()){let t=[];for(let o of e.types){let n=g(o,r);if(!n)return;t.push(n)}return{type:"union",types:t}}if(j(e)){let t=g(e.resolvedTypeArguments[0],r);return t?{type:"array",itemType:t}:void 0}if(L(e))return g(e.resolvedTypeArguments[0],r);if(C(e))return{type:"date"};if(B(e)){let t=[],o=e.getSymbol()?.getDeclarations();try{for(let n of e.getProperties()){let i=n.getDeclarations()?.[0]??o?.[0];if(!i)continue;let c=g(r.getTypeAtLocation(i),r);if(!c)return;t.push([n.getName(),c])}return{type:"object",keyValuePairTypes:t}}catch{return}}}function D(e){return!!(e.flags&a.default.TypeFlags.BooleanLiteral)}function j(e){return e.getSymbol()?.name==="Array"}function L(e){return e.getSymbol()?.name==="Promise"}function C(e){return!!(e.flags&a.default.TypeFlags.Object)&&"objectFlags"in e&&e.symbol.escapedName==="Date"}function B(e){return!!(e.flags&a.default.TypeFlags.Object)&&"objectFlags"in e&&"properties"in e&&!e.isClass()&&e.getCallSignatures().length===0}var P=/^[a-zA-Z_$][a-zA-Z0-9_$]*$/;function x(e,r){let t=e.getTypeChecker(),o=t.getSignatureFromDeclaration(r);if(!o)return;let n=r.name?.getText();if(!n)return;let i=[];for(let l=0;l<r.parameters.length;l++){let p=r.parameters[l];if(!p.type)return;let s=g(t.getTypeFromTypeNode(p.type),t);if(!s)return;let f=p.name.getText();i.push({name:P.test(f)?f:`param${l}`,type:s})}let c=g(t.getReturnTypeOfSignature(o),t);if(c)return{functionName:n,params:i,returnType:c}}var d="hyperlight";var u={Reset:"\x1B[0m",FgRed:"\x1B[31m",FgGreen:"\x1B[32m",FgYellow:"\x1B[33m",FgMagenta:"\x1B[35m",FgCyan:"\x1B[36m",FgGray:"\x1B[90m",BgRed:"\x1B[41m",BgGreen:"\x1B[42m",BgYellow:"\x1B[43m",BgMagenta:"\x1B[45m",BgCyan:"\x1B[46m",BgGray:"\x1B[100m"};var _="registerRpc",N=new Set;function k(e,r,{ts:t}){return console.log(`Applying the ${d} magic...`),o=>{let n=o.factory;return i=>{let c=i.fileName,l=s=>{let f=M(s,e,c,t);if(!f)return t.isFunctionDeclaration(s)||t.isClassDeclaration(s)||t.isVariableDeclaration(s)?s:t.visitEachChild(s,l,o);let F=n.createCallExpression(G(n),void 0,[n.createIdentifier(f.functionName),n.createStringLiteral(JSON.stringify(f))]),h=n.createNodeArray([s,F,n.createToken(b.default.SyntaxKind.SemicolonToken)]);return N.add(f.functionName),h};return t.visitNode(i,l)}}}function M(e,r,t,o){if(!o.isFunctionDeclaration(e)||!O(e,o))return;let n=e.name?.getText(),i=x(r,e);if(!i){console.log(`${u.BgRed}${t}#${n}${u.Reset}
  couldn't parse signature; ${u.FgYellow}skipped${u.Reset}
  make sure the arguments and return value are serialisable (contain no functions, classes or recursive structures)

`);return}if(N.has(i.functionName)){console.log(`${u.BgRed}${t}#${n}${u.Reset}
  duplicate endpoint name; ${u.FgYellow}skipped${u.Reset}
  make sure your endpoint names are unique across the project in their function definitions, not just in export aliases

`);return}return{...i,jsDoc:Y(e,o)}}function O(e,r){return r.getJSDocTags(e).some(o=>o.tagName.text==="endpoint")}function G(e){return e.createPropertyAccessExpression(e.createCallExpression(e.createIdentifier("require"),void 0,[e.createStringLiteral(d)]),e.createIdentifier(_))}function Y(e,r){let t=r.getJSDocCommentsAndTags(e),o=[];for(let n of t)if(typeof n=="string"&&o.push(n),"tags"in n){o.push(n.comment);for(let i of n.tags??[])o.push(`@${i.tagName.text} ${i.comment??""}`)}return o.join(`
`).replaceAll("@endpoint","").trim()}
