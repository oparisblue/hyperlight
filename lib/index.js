"use strict";var h=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var I=(n,t)=>{for(var e in t)h(n,e,{get:t[e],enumerable:!0})},O=(n,t,e,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of _(t))!k.call(n,r)&&r!==e&&h(n,r,{get:()=>t[r],enumerable:!(o=V(t,r))||o.enumerable});return n};var L=n=>O(h({},"__esModule",{value:!0}),n);var U={};I(U,{contextValue:()=>N,getRequest:()=>B,init:()=>M,registerRpc:()=>R});module.exports=L(U);var u=new Map;function R(n,t){let e=JSON.parse(t);u.set(e.functionName,{handler:n,signature:e})}var F=require("hyper-express");var G=[["year",31536e6],["month",2592e6],["week",6048e5],["day",864e5],["hour",36e5],["minute",6e4],["second",1e3]];function v(n,t){let e=[],o=Math.abs(t.getTime()-n.getTime());for(let[r,a]of G){let c=Math.floor(o/a),d=o%a;c>0&&(e.push(`${c} ${r}${c!==1?"s":""}`),o=d)}return e.length===0?`${o} ms`:e.join(", ")}var m=class{port;devMode;pingPath;schemaPath;rpcPath;startTime=new Date;getUptime(){let t=new Date;return{uptime:v(this.startTime,t),uptimeRaw:Math.abs(t.getTime()-this.startTime.getTime())}}_requestsHandled=0;get requestsHandled(){return this._requestsHandled}incrementRequestsHandled(){this._requestsHandled++}get hasPing(){return this.pingPath!==null}get hasSchema(){return this.schemaPath!==null}constructor({port:t=3e3,devMode:e,pingPath:o="/",schemaPath:r="/schema",rpcPath:a="/rpc"}){this.port=t,this.devMode=e,this.pingPath=e?o:null,this.schemaPath=e?r:null,this.rpcPath=a}};var P="hyperlight";var p={Reset:"\x1B[0m",FgRed:"\x1B[31m",FgGreen:"\x1B[32m",FgYellow:"\x1B[33m",FgMagenta:"\x1B[35m",FgCyan:"\x1B[36m",FgGray:"\x1B[90m",BgRed:"\x1B[41m",BgGreen:"\x1B[42m",BgYellow:"\x1B[43m",BgMagenta:"\x1B[45m",BgCyan:"\x1B[46m",BgGray:"\x1B[100m"};function l(n,t){if(typeof n!="object"||n==null)throw new s;let e=t.type==="union"?n:n.v;switch(t.type){case"null":if(e!==null)throw new s("expected null");return null;case"undefined":if(e!==void 0)throw new s("expected undefined");return;case"void":return;case"numberLiteral":case"stringLiteral":case"booleanLiteral":if(e!==t.value)throw new s(`expected ${t.type}`);return e;case"number":if(typeof e!="number")throw new s("expected number");return e;case"boolean":if(typeof e!="boolean")throw new s("expected boolean");return e;case"string":if(typeof e!="string")throw new s("expected string");return e;case"union":for(let r of t.types)try{return l(e,r)}catch{}throw new s(`not in union, expected ${t.types.map(r=>r.type).join(" or ")}`);case"array":if(!Array.isArray(e))throw new s("expected array");return e.map(r=>l(r,t.itemType));case"object":if(typeof e!="object"||e==null)throw new s("expected object");let o={};for(let[r,a]of t.keyValuePairTypes){if(!(r in e))throw new s(`key "${r}" not in object`);o[r]=l(e[r],a)}return o;case"date":if(typeof e!="string")throw new s("expected date iso string");return new Date(e)}}var s=class extends Error{};function S(n){i.pingPath!==null&&n.get(i.pingPath,(t,e)=>{let{schemaPath:o,rpcPath:r,requestsHandled:a}=i,{uptime:c,uptimeRaw:d}=i.getUptime(),f=`${t.protocol}://${t.hostname}:${i.port}`,x=`${f}${i.pingPath}`,b=`${f}${r}`,w=o?`${f}${o}`:null;if(t.query_parameters.json!=null){e.type("text/json").send(JSON.stringify({uptime:c,uptimeRaw:d,requestsHandled:a,rpcPath:b,schemaPath:w},null,2));return}e.type("text/plain").send(`Service is up!

Uptime:               ${c}
RPC requests handled: ${a}

RPC endpoint:         ${b}
Schema endpoint:      ${w??"disabled"}

Run "npx ${P} add-client ${x}" to set up an RPC client against this service.

This page only appears while dev mode is enabled in your service's configuration.
You can also go to ${x}?json to receive this data formatted as JSON.
`)})}function $(n){n.post(i.rpcPath,async(t,e)=>{let o=await t.json();if(!o){e.sendStatus(400);return}let r=H(o);if(!r){e.sendStatus(400);return}try{let a=await r();e.type("text/json").send(JSON.stringify(g(a))),i.incrementRequestsHandled()}catch(a){console.log(a),e.sendStatus(500)}})}function H({name:n,params:t}){if(!n)return;let e=u.get(n);if(!e)return;let o=e.signature.params.length;if(o===0)return async()=>e.handler();if(t)try{let r=[];if(!Array.isArray(t)||t.length!==o)return;for(let a=0;a<o;a++)try{r.push(l(t[a],e.signature.params[a].type))}catch{return}return async()=>e.handler(...r)}catch(r){console.log(r);return}}function g(n){return n instanceof Date?{v:n.toISOString(),t:"date"}:Array.isArray(n)?{v:n.map(t=>g(t))}:typeof n=="object"&&n!=null?{v:Object.entries(n).reduce((t,[e,o])=>({...t,[e]:g(o)}),{})}:{v:n}}var C;function T(n){i.schemaPath!==null&&n.get(i.schemaPath,async(t,e)=>{e.type("text/json").send(C??E())})}function E(){let n=[];for(let e of u.values())n.push(e.signature);let t=JSON.stringify(n);return C=t,t}var D=require("domain"),j=require("crypto"),A=[];function q(n){n.use((t,e,o)=>{let r=(0,D.create)();r.context={request:t};for(let{key:a,defaultValue:c}of A)r.context[a]=c;r.on("error",a=>{e.sendStatus(500),o(a)}),r.run(o)})}function y(){return process.domain.context}function B(){return y().request}function N(n){let t=(0,j.randomUUID)();return A.push({key:t,defaultValue:n}),{getValue(){return y()[t]},setValue(e){y()[t]=e}}}var i;function M(n){i=new m(n);let t=i.port,e=new F.Server;S(e),$(e),T(e),q(e),n.setup?.(e),e.listen(t).then(()=>{console.log(`${p.FgGreen}\u2714 Service running at http://localhost:${t} with ${u.size} ${u.size===1?"endpoint":"endpoints"}${p.Reset}`)}).catch(()=>{console.error(`${p.FgRed}\u2716\uFE0F Service failed to start at port ${t}${p.Reset}`)})}0&&(module.exports={contextValue,getRequest,init,registerRpc});
